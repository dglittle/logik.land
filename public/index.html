<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>logik.land</title>
</head>
<body style="margin:0px"></body>
<script>

var url_params = {}
location.hash.substr(1).split(',').forEach(function (x) {
    var y = x.split('=')
    url_params[y[0]] = y[1]
})

var PALETTE_HEIGHT = 20
var LOOP_INTERVAL = 20 // 20

var c = null
var g = null
var render_prep_image_data = null
var render_prep_canvas = null
var checker_canvas = null
var checker_pattern = null

var view = {
    scale : url_params.scale || 2,
    brush : 'toggle_toggle',
    play : true,
    prev_x : 0,
    prev_y : 0,
    box : null
}

var version = 0
var model = {} // { x: , y: , t: , c: , v: } (t=type, c=charge, v=version)

var stuff_sizes = {
    wire : 1,
    cross_gate : 1,
    and_gate : 3,
    or_gate : 3,
    nand_gate : 3,
    toggle : 3
}

var stuff_colors = {
    wire : {
        on : [255, 255, 0],
        off : [80, 80, 0]
    },
    cross_gate : {
        on : [0, 0, 0],
        off : [0, 0, 0]
    },
    or_gate : {
        on : [255, 128, 0],
        off : [128, 64, 0]
    },
    and_gate : {
        on : [0, 0, 255],
        off : [0, 0, 128]
    },
    nand_gate : {
        on : [255, 0, 255],
        off : [128, 0, 128]
    },
    toggle : {
        on : [0, 255, 255],
        off : [0, 128, 128]
    }
}

var wave_front = {}

function update_model(changes) {
    each(changes, function (_, key) {
        if (_) {
            model[key] = _
        } else {
            delete model[key]
        }
    })
    
    wave_front = model
    version = 0
    each(model, function (_) {
        if (_.v > version) version = _.v
    })
    
    render_prep()
    render()
}

function set_new_model(new_model) {
    var changes = {}
    each(model, function (_, key) {
        changes[key] = null
    })
    each(new_model, function (_, key) {
        changes[key] = _
    })
    update_model(changes)
}

function copy_view_box() {
    var ret = {}
    for (var y = view.box[1]; y <= view.box[3]; y++) {
        for (var x = view.box[0]; x <= view.box[2]; x++) {
            var key = x + ',' + y
            var _ = model[key]
            if (_) ret[key] = _
        }
    }
    return ret
}

function delete_view_box(changes) {
    var the_dead = copy_view_box()
    each(the_dead, function (_, key) {
        changes[key] = null
    })
    return the_dead
}

function get_thing_at(x, y) {
    for (var dx = 0; dx >= -2; dx--) {
        for (var dy = 0; dy >= -2; dy--) {
            var thing = model[(x + dx) + ',' + (y + dy)]
            if (thing && (-dx) < stuff_sizes[thing.t] && (-dy) < stuff_sizes[thing.t]) {
                return thing
            }
        }
    }
}

function draw_palette() {
    var d = document.createElement('div')
    d.style.position = 'fixed'
    d.style.left = '0px'
    d.style.top = '0px'
    d.style.width = '100%'

    if (window.innerWidth / 40 < 13) {
	    d.style.height = '80px'
    } else {
	    d.style.height = '40px'
    }

    function createLogo() {
        var b = document.createElement('div')
        b.style.background = 'white'
        b.style.display = 'inline-block'
        b.style.width = '80px'
        b.style.height = '40px'
        b.onclick = function () {
        }

        var c = document.createElement('canvas')
        c.width = 80
        c.height = 40
        var g = c.getContext('2d')

		g.fillStyle = 'black'
		var logo = `
			X...XXX.XXX.X.X..X..X....X..X..X.XX.
			X...X.X.X.....X.X...X...X.X.XX.X.X.X
			X...X.X.X.X.X.XX....X...XXX.X.XX.X.X
			X...X.X.X.X.X.X.X...X...X.X.X..X.X.X
			XXX.XXX.XXX.X.X.X.X.XXX.X.X.X..X.XX.
		`
		each(logo.trim().split(/\r?\n/), function (row, ri) {
			row = row.trim()
			for (var i = 0; i < row.length; i++) {
				if (row[i] == 'X') {
					g.fillRect(i * 2, ri * 2, 2, 2)
				}
			}
		})

        b.append(c)
        d.append(b)
    }
    createLogo()

    function drawMagnifyingGlass(c, g) {
        g.beginPath()
        g.moveTo(17, 17)
        g.lineTo(33, 33)
        g.lineWidth = 2
        g.strokeStyle = 'black'
        g.stroke()

		g.beginPath()
		g.arc(17.5, 17.5, 10, 0, 2*Math.PI)
		g.fillStyle = 'lightblue'
		g.fill()
        g.strokeStyle = 'black'
		g.stroke()
    }

    function createZoomInButton() {
        var b = document.createElement('div')
        b.style.background = 'white'
        b.style.display = 'inline-block'
        b.style.width = '40px'
        b.style.height = '40px'
        b.onclick = function () {
            var b = document.body
            var x = (b.scrollLeft + b.clientWidth / 2) / b.scrollWidth
            var y = (b.scrollTop + b.clientHeight / 2) / b.scrollHeight

	        view.scale *= 2
            render_prep()
	        render()

            b.scrollLeft = x * b.scrollWidth - b.clientWidth / 2
            b.scrollTop = y * b.scrollHeight - b.clientHeight / 2
        }

        var c = document.createElement('canvas')
        c.width = 40
        c.height = 40
        var g = c.getContext('2d')

        drawMagnifyingGlass(c, g)

		g.fillStyle = 'black'
		g.fillRect(12, 16, 11, 3)
		g.fillRect(16, 12, 3, 11)

        b.append(c)
        d.append(b)
    }
    createZoomInButton()
    
    function createZoomOutButton() {
        var b = document.createElement('div')
        b.style.background = 'white'
        b.style.display = 'inline-block'
        b.style.width = '40px'
        b.style.height = '40px'
        b.onclick = function () {
            var b = document.body
            var x = (b.scrollLeft + b.clientWidth / 2) / b.scrollWidth
            var y = (b.scrollTop + b.clientHeight / 2) / b.scrollHeight

	        view.scale = Math.floor(view.scale/2)
	        if (view.scale < 1) view.scale = 1
            render_prep()
	        render()

            b.scrollLeft = x * b.scrollWidth - b.clientWidth / 2
            b.scrollTop = y * b.scrollHeight - b.clientHeight / 2
        }

        var c = document.createElement('canvas')
        c.width = 40
        c.height = 40
        var g = c.getContext('2d')

        drawMagnifyingGlass(c, g)

		g.fillStyle = 'black'
		g.fillRect(12, 16, 11, 3)

        b.append(c)
        d.append(b)
    }
    createZoomOutButton()

    function createStopButton() {
        var b = document.createElement('div')
        b.style.background = 'white'
        b.style.display = 'inline-block'
        b.style.width = '40px'
        b.style.height = '40px'

        var c = document.createElement('canvas')
        c.width = 40
        c.height = 40
        var g = c.getContext('2d')

        function redraw() {
        	g.clearRect(0, 0, 40, 40)

			g.fillStyle = 'black'
			if (view.play) {
				g.fillRect(12, 12, 40 - 12*2, 40 - 12*2)
			} else {
				g.beginPath()
				g.moveTo(12, 12)
				g.lineTo(12, 40 - 12)
				g.lineTo(40 - 12, 20)
				g.fill()
			}
        }
        redraw()

        b.onclick = function () {
	        view.play = !view.play
	        redraw()
	        render()
        }

        b.append(c)
        d.append(b)
    }
    createStopButton()

    var last_save_url = null
    function createSaveButton() {
        var b = document.createElement('div')
        b.style.background = 'white'
        b.style.display = 'inline-block'
        b.style.width = '40px'
        b.style.height = '40px'

        var c = document.createElement('canvas')
        c.width = 40
        c.height = 40
        var g = c.getContext('2d')

        g.fillStyle = 'black'
        g.beginPath()
        g.moveTo(10, 20)
        g.lineTo(30, 20)
        g.lineTo(20, 30)
        g.fill()
        g.fillRect(18, 10, 4, 10)
        g.fillRect(10, 29, 20, 1)

        b.onclick = function () {
            var a = document.createElement('a')
            if (last_save_url)
                window.URL.revokeObjectURL(last_save_url)
            last_save_url = window.URL.createObjectURL(new Blob([JSON.stringify(model)], { type : 'text/plain' }))
            a.setAttribute('href', last_save_url)
            a.setAttribute('download', 'chip.txt')
            a.style.display = 'none'
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)

            // var a = document.createElement('a')
            // a.setAttribute('href', render_prep_canvas.toDataURL('image/png'))
            // a.setAttribute('download', 'chip.png')
            // a.style.display = 'none'
            // document.body.appendChild(a)
            // a.click()
            // document.body.removeChild(a)
        }

        b.append(c)
        d.append(b)
    }
    createSaveButton()

    function createUploadButton() {
        var b = document.createElement('div')
        b.style.background = 'white'
        b.style.display = 'inline-block'
        b.style.width = '40px'
        b.style.height = '40px'

        var c = document.createElement('canvas')
        c.width = 40
        c.height = 40
        var g = c.getContext('2d')

        g.fillStyle = 'black'
        g.beginPath()
        g.moveTo(10, 20)
        g.lineTo(30, 20)
        g.lineTo(20, 10)
        g.fill()
        g.fillRect(18, 20, 4, 10)
        g.fillRect(10, 10, 20, 1)

        b.onclick = function () {
            var inp = document.createElement('input')
            inp.setAttribute('type', 'file')
            inp.onchange = function () {
                if (this.files.length == 1) {
                    var r = new FileReader()
                    r.onload = function (e) {
                        set_new_model(JSON.parse(e.target.result))

                        // var im = new Image()
                        // im.onload = function () {
                        //     var c = document.createElement('canvas')
                        //     c.width = im.width
                        //     c.height = im.height
                        //     var g = c.getContext('2d')
                        //     g.drawImage(im, 0, 0, im.width, im.height)
                        //     var data = g.getImageData(0, 0, im.width, im.height).data
                        //     var new_model = {}
                        //     var i = 0
                        //     for (var y = 0; y < im.height; y++) {
                        //         for (var x = 0; x < im.width; x++) {
                        //             var R = data[i++]
                        //             var G = data[i++]
                        //             var B = data[i++]
                        //             var A = data[i++]

                        //             var found_overlapping_gate = false
                        //             for (var yy = -2; yy <= 0; yy++) {
                        //                 for (var xx = -2; xx <= 0; xx++) {
                        //                     var thing = new_model[(x + xx) + ',' + (y + yy)]
                        //                     if (thing && (stuff_sizes[thing.t] == 3)) {
                        //                         found_overlapping_gate = true
                        //                     }
                        //                 }
                        //             }
                        //             if (found_overlapping_gate) continue

                        //             function color_comp(x) {
                        //                 return x[0] == R && x[1] == G && x[2] == B && A == 255
                        //             }
                        //             each(stuff_colors, function (color, thing) {
                        //                 if (color_comp(color.on)) {
                        //                     new_model[x + ',' + y] = { x : x, y : y, t : thing, c : 1, v : 0 }
                        //                 }
                        //                 if (color_comp(color.off)) {
                        //                     new_model[x + ',' + y] = { x : x, y : y, t : thing, c : -1, v : 0 }
                        //                 }
                        //             })
                        //         }
                        //     }
                        //     set_new_model(new_model)
                        // }
                        // im.src = r.result
                    }
                    r.readAsText(this.files[0])
                }
                document.body.removeChild(inp)
            }
            inp.style.display = 'none'
            document.body.append(inp)
            inp.click()
        }

        b.append(c)
        d.append(b)
    }
    createUploadButton()

    var radio_buttons = {}
    
    function create_radio_button(drawOn, drawOff, brush, clickRightAway) {
        var b = document.createElement('div')
        b.style.display = 'inline-block'
        b.style.width = '40px'
        b.style.height = '40px'

        var c = document.createElement('canvas')
        c.width = 40
        c.height = 40
        var g = c.getContext('2d')
        b.append(c)

        b.onclick = function () {
            view.brush = brush
            each(radio_buttons, function (x, k) {
            	if (k != brush) x.drawOff(x.c, x.g)
            })
            drawOn(c, g)
        }

        radio_buttons[brush] = { c : c, g : g, drawOff : drawOff }
        if (clickRightAway) b.onclick()
        d.append(b)
    }
    
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)

        g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(10, 18, 20, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)

        g.fillStyle = 'rgb(128, 128, 0)'
    	g.fillRect(10, 18, 20, 4)
    }, 'wire')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)

        g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(10, 18, 20, 4)
    	g.fillRect(18, 14, 4, 12)
    	g.fillStyle = 'rgb(0, 0, 0)'
    	g.fillRect(18, 18, 4, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)

        g.fillStyle = 'rgb(128, 128, 0)'
    	g.fillRect(10, 18, 20, 4)
    	g.fillRect(18, 14, 4, 12)
    	g.fillStyle = 'rgb(0, 0, 0)'
    	g.fillRect(18, 18, 4, 4)
    }, 'cross_gate')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)
        g.fillStyle = 'rgb(255, 128, 0)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(255, 255, 0)'
        g.fillRect(10, 14, 4, 4)
        g.fillRect(26, 18, 4, 4)
        g.fillStyle = 'rgb(80, 80, 0)'
        g.fillRect(10, 22, 4, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)
        g.fillStyle = 'rgb(128, 64, 0)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(80, 80, 0)'
        g.fillRect(10, 14, 4, 4)
        g.fillRect(26, 18, 4, 4)
        g.fillRect(10, 22, 4, 4)
    }, 'or_gate')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)
        g.fillStyle = 'rgb(0, 0, 255)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(255, 255, 0)'
        g.fillRect(10, 14, 4, 4)
        g.fillRect(26, 18, 4, 4)
        g.fillRect(10, 22, 4, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)
        g.fillStyle = 'rgb(0, 0, 128)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(80, 80, 0)'
        g.fillRect(10, 14, 4, 4)
        g.fillRect(26, 18, 4, 4)
        g.fillRect(10, 22, 4, 4)
    }, 'and_gate')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)
        g.fillStyle = 'rgb(255, 0, 255)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(255, 255, 0)'
        g.fillRect(26, 18, 4, 4)
        g.fillStyle = 'rgb(80, 80, 0)'
        g.fillRect(10, 14, 4, 4)
        g.fillRect(10, 22, 4, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)
        g.fillStyle = 'rgb(128, 0, 128)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(255, 255, 0)'
        g.fillRect(10, 14, 4, 4)
        g.fillRect(10, 22, 4, 4)
        g.fillStyle = 'rgb(80, 80, 0)'
        g.fillRect(26, 18, 4, 4)
    }, 'nand_gate')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)

        g.fillStyle = 'rgb(0, 255, 255)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(255, 255, 0)'
        g.fillRect(26, 18, 4, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)

        g.fillStyle = 'rgb(0, 128, 128)'
        g.fillRect(14, 14, 12, 12)
        g.fillStyle = 'rgb(80, 80, 0)'
        g.fillRect(26, 18, 4, 4)
    }, 'toggle')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)

    	g.beginPath()
    	g.moveTo(10, 10)
    	g.lineTo(30, 30)
    	g.moveTo(10, 30)
    	g.lineTo(30, 10)
    	g.lineWidth = 4
    	g.strokeStyle = 'rgb(255, 0, 0)'
    	g.stroke()
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)

    	g.beginPath()
    	g.moveTo(10, 10)
    	g.lineTo(30, 30)
    	g.moveTo(10, 30)
    	g.lineTo(30, 10)
    	g.lineWidth = 1
    	g.strokeStyle = 'rgb(128, 0, 0)'
    	g.stroke()
    }, 'delete')
    create_radio_button(function (c, g) {
    	g.fillStyle = 'rgb(255, 255, 0)'
    	g.fillRect(0, 0, 40, 40)
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(4, 4, 32, 32)

    	g.fillStyle = 'rgb(255, 0, 0)'
    	g.fillRect(10, 10, 20, 4)
        g.fillRect(10, 10, 4, 20)
        g.fillRect(10 + 20 - 4, 10, 4, 20)
        g.fillRect(10, 10 + 20 - 4, 20, 4)
    }, function (c, g) {
    	g.fillStyle = 'rgb(0, 40, 0)'
    	g.fillRect(0, 0, 40, 40)

        g.fillStyle = 'rgb(128, 0, 0)'
        g.fillRect(10, 10, 20, 1)
        g.fillRect(10, 10, 1, 20)
        g.fillRect(10 + 20 - 1, 10, 1, 20)
        g.fillRect(10, 10 + 20 - 1, 20, 1)
    }, 'box', true)
    create_radio_button(function (c, g) {
        g.fillStyle = 'rgb(255, 255, 0)'
        g.fillRect(0, 0, 40, 40)
        g.fillStyle = 'rgb(0, 40, 0)'
        g.fillRect(4, 4, 32, 32)

        g.fillStyle = 'rgb(' + stuff_colors.toggle.on.join(',') + ')'
        g.fillRect(14, 6, 12, 12)
        g.fillStyle = 'rgb(' + stuff_colors.toggle.off.join(',') + ')'
        g.fillRect(14, 22, 12, 12)
    }, function (c, g) {
        g.fillStyle = 'rgb(0, 40, 0)'
        g.fillRect(0, 0, 40, 40)

        g.fillStyle = 'rgb(' + stuff_colors.toggle.off.join(',') + ')'
        g.fillRect(14, 6, 12, 12)
        g.fillStyle = 'rgb(' + stuff_colors.toggle.off.join(',') + ')'
        g.fillRect(14, 22, 12, 12)
    }, 'toggle_toggle', true)

    document.addEventListener('keydown', function (e) {
        if (view.brush == 'box' && e.keyCode == 8 && view.box && view.box.length == 4) {
            // 8 = DELETE
            var changes = {}
            delete_view_box(changes)
            update_model(changes)
        } else if (view.brush == 'box' && e.keyCode == 72 && view.box && view.box.length == 4) {
            // 72 = h
            var changes = {}
            var the_dead = delete_view_box(changes)
            each(the_dead, function (_) {
                var X = view.box[0] + (view.box[2] - view.box[0]) - (_.x - view.box[0]) - (stuff_sizes[_.t] - 1)
                var Y = _.y
                changes[X + ',' + Y] = {
                    x : X,
                    y : Y,
                    t : _.t,
                    c : _.c,
                    v : _.v
                }
            })
            update_model(changes)
        } else if (view.brush == 'box' && e.keyCode == 86 && view.box && view.box.length == 4) {
            // 86 = v
            var changes = {}
            var the_dead = delete_view_box(changes)
            each(the_dead, function (_) {
                var X = _.x
                var Y = view.box[1] + (view.box[3] - view.box[1]) - (_.y - view.box[1]) - (stuff_sizes[_.t] - 1)
                changes[X + ',' + Y] = {
                    x : X,
                    y : Y,
                    t : _.t,
                    c : _.c,
                    v : _.v
                }
            })
            update_model(changes)
        } else if (view.brush == 'box' && e.keyCode == 70 && view.box && view.box.length == 4) {
            // 70 = f
            var changes = {}
            var the_dead = delete_view_box(changes)
            each(the_dead, function (_) {
                var X = _.y - view.box[1] + view.box[0]
                var Y = _.x - view.box[0] + view.box[1]
                changes[X + ',' + Y] = {
                    x : X,
                    y : Y,
                    t : _.t,
                    c : _.c,
                    v : _.v
                }
            })
            view.box = [view.box[0], view.box[1], view.box[3] - view.box[1] + view.box[0], view.box[2] - view.box[0] + view.box[1]]
            update_model(changes)
        }
    })

    return d
}

function get_adjacent(x, y) {
    return [
        [x, y - 1, x, y - 2],
        [x + 1, y, x + 2, y],
        [x, y + 1, x, y + 2],
        [x - 1, y, x - 2, y]
    ]
}

function propagate() {
    version++
    var changes = {}
    var new_wave_front = {}
    each(wave_front, function (_, key) {
        _ = get_thing_at(_.x, _.y)
        if (!_) { return }
        key = _.x + ',' + _.y
        if (_.t == 'wire') {
            var best_v = _.v
            var best_c = _.c
            var adj = get_adjacent(_.x, _.y)
            each(adj, function (a, i) {
                var __ = get_thing_at(a[0], a[1])
                if (__ && __.t == 'cross_gate') {
                    __ = model[a[2] + ',' + a[3]]
                    if (__ && __.t == 'wire' && __.v > best_v) {
                        best_v = __.v
                        best_c = __.c
                    }
                } else if (__ && (__.t == 'wire' || (_.x == __.x + 1 || _.y == __.y + 1)) && __.v > best_v) {
                    best_v = __.v
                    best_c = __.c
                }
            })
            if (best_v != _.v) {
                changes[key] = {
                    c : best_c,
                    v : best_v
                }
                each(adj, function (__) {
                    new_wave_front[__[0] + ',' + __[1]] = {
                        x : __[0],
                        y : __[1]
                    }
                })
            }
        } else if (_.t == 'cross_gate') {
            _.c = -1
            each(get_adjacent(_.x, _.y), function (__) {
                var w = model[__[0] + ',' + __[1]]
                if (w && w.t == 'wire') {
                    if (w.c > 0) _.c = 1
                    new_wave_front[__[0] + ',' + __[1]] = {
                        x : __[0],
                        y : __[1]
                    }
                }
            })
        } else if (stuff_sizes[_.t] == 3) {
            var high_count = 0
            var low_count = 0
            each([
                model[(_.x + 0) + ',' + (_.y - 1)],
                model[(_.x + 2) + ',' + (_.y - 1)],
                model[(_.x + 3) + ',' + (_.y + 0)],
                model[(_.x + 3) + ',' + (_.y + 2)],
                model[(_.x + 0) + ',' + (_.y + 3)],
                model[(_.x + 2) + ',' + (_.y + 3)],
                model[(_.x - 1) + ',' + (_.y + 0)],
                model[(_.x - 1) + ',' + (_.y + 2)]
            ], function (__) {
                if (__ && __.t == 'wire') {
                    if (__.c > 0) high_count++
                    else low_count++
                }
            })
            var output = -1
            if (_.t == 'or_gate' && high_count > 0)
                output = 1
            if (_.t == 'and_gate' && low_count == 0)
                output = 1
            if (_.t == 'nand_gate' && low_count != 0)
                output = 1
            if (_.t == 'toggle')
                output = _.cc
            
            if (output != _.c) {
                changes[key] = {
                    c : output,
                    v : version
                }
                each([
                    [_.x + 1, _.y - 1],
                    [_.x + 3, _.y + 1],
                    [_.x + 1, _.y + 3],
                    [_.x - 1, _.y + 1]
                    ], function (pos) {
                    var w = model[pos[0] + ',' + pos[1]]
                    if (w && w.t == 'wire') {
                        new_wave_front[pos[0] + ',' + pos[1]] = {
                            x : pos[0],
                            y : pos[1]
                        }
                    }
                })
            }
        }        
    })

    if (view.shocks) {
        view.shocks--
        each(view.shocker, function (charge, key) {
            var _ = model[key]
            if (_) {
                changes[key] = {
                    c : charge,
                    v : version
                }
                var comma = key.indexOf(',')
                var x = 1*key.slice(0, comma)
                var y = 1*key.slice(comma + 1)

                each(get_adjacent(x, y), function (__) {
                    new_wave_front[__[0] + ',' + __[1]] = {
                        x : __[0],
                        y : __[1]
                    }
                })
            }
        })
    }
    
    each(changes, function (_, key) {
        model[key].c = _.c
        model[key].v = _.v
        draw_thing(model[key])
    })
    
    wave_front = new_wave_front
}

function set_pixel(x, y, color) {
    if (render_prep_image_data) {
        var base = (y - view.low_y) * render_prep_image_data.width * 4 + (x - view.low_x) * 4
        render_prep_image_data.data[base + 0] = color[0]
        render_prep_image_data.data[base + 1] = color[1]
        render_prep_image_data.data[base + 2] = color[2]
        render_prep_image_data.data[base + 3] = 255
    }
}

function draw_thing(_) {
    if (_.t == 'wire') {
        set_pixel(_.x, _.y, _.c > 0 ? stuff_colors.wire.on : stuff_colors.wire.off)
    } else if (_.t == 'cross_gate') {
        set_pixel(_.x, _.y, _.c > 0 ? stuff_colors.cross_gate.on : stuff_colors.cross_gate.off)
    } else {
        var color = stuff_colors[_.t]
        if (!color) color = [255, 0, 0]
        else color = _.c > 0 ? color.on : color.off
        for (var yy = 0; yy < 3; yy++) {
            for (var xx = 0; xx < 3; xx++) {
                set_pixel(_.x + xx, _.y + yy, color)
            }
        }
    }
}

function render_prep() {
    var x1 = Infinity
    var y1 = Infinity
    var x2 = -Infinity
    var y2 = -Infinity

    each(model, function (_) {
        if (_.x < x1) x1 = _.x
        if (_.y < y1) y1 = _.y
        if (_.x + (stuff_sizes[_.t] - 1) > x2) x2 = _.x + (stuff_sizes[_.t] - 1)
        if (_.y + (stuff_sizes[_.t] - 1) > y2) y2 = _.y + (stuff_sizes[_.t] - 1)
    })
    
    if (x1 == Infinity) {
        x1 = 0
        y1 = 0
        x2 = 0
        y2 = 0
    }
    
    var width = x2 - x1 + 1
    var height = y2 - y1 + 1
    
    view.low_x = x1
    view.low_y = y1
    view.used_width = width
    view.used_height = height

    if (!c) {
        c = document.createElement('canvas')
        document.body.append(c)
    }
    c.width = Math.max(width + 200, window.innerWidth * window.devicePixelRatio)
    c.height = Math.max(height + 200, window.innerHeight * window.devicePixelRatio)
    c.style.width = c.width / window.devicePixelRatio * view.scale
    c.style.height = c.height / window.devicePixelRatio * view.scale
    c.style['image-rendering'] = 'pixelated'
    g = c.getContext('2d')

    if (!render_prep_canvas)
        render_prep_canvas = document.createElement('canvas')
    render_prep_canvas.width = width
    render_prep_canvas.height = height
    
    render_prep_image_data = g.createImageData(width, height)
    each(model, function (_, key) {
        draw_thing(_)
    })

    if (!checker_canvas) {
        checker_canvas = document.createElement('canvas')
        checker_canvas.width = 2
        checker_canvas.height = 2
        checker_canvas.getContext('2d').fillStyle = 'rgba(0, 32, 0, 1)'
        checker_canvas.getContext('2d').fillRect(0, 0, 2, 2)
        checker_canvas.getContext('2d').fillStyle = 'rgba(0, 40, 0, 1)'
        checker_canvas.getContext('2d').fillRect(1, 0, 1, 1)
        checker_canvas.getContext('2d').fillRect(0, 1, 1, 1)
        checker_pattern = g.createPattern(checker_canvas, 'repeat')
    }
}

function render() {
    g.fillStyle = checker_pattern
    g.fillRect(0, 0, c.width, c.height)

    render_prep_canvas.getContext('2d').putImageData(render_prep_image_data, 0, 0)
    g.imageSmoothingEnabled = false
    var x = Math.floor((c.width - render_prep_image_data.width) / 2)
    var y = Math.floor((c.height - render_prep_image_data.height) / 2)
    g.drawImage(render_prep_canvas, x, y, view.used_width, view.used_height)

    if (view.brush == 'box' && view.box) {
        g.fillStyle = 'rgba(255,0,0,0.6)'

        var ox = Math.floor((c.width - render_prep_canvas.width)/2 - view.low_x)
        var oy = Math.floor((c.height - render_prep_canvas.height)/2 - view.low_y)
        if (view.box.length == 2)
            g.fillRect(ox + view.box[0], oy + view.box[1], 1, 1)
        else
            g.fillRect(ox + view.box[0], oy + view.box[1], view.box[2] - view.box[0] + 1, view.box[3] - view.box[1] + 1)
    }
}

if (!url_params.hide_palette)
    document.body.append(draw_palette())

var t1_agg = 0
var t2_agg = 0

function loop() {
    
    var a = 0.1
    
    if (view.play) {
        var t0 = Date.now()
        propagate()
        propagate()
        propagate()
        propagate()
        propagate()
        propagate()
        propagate()
        propagate()
        propagate()
        propagate()
        var t1 = Date.now()
        t1_agg = a * (t1 - t0) + (1 - a) * t1_agg

        var t0 = Date.now()
        render()
        var t1 = Date.now()
        t2_agg = a * (t1 - t0) + (1 - a) * t2_agg
        
        // if (Math.random() < 0.03) {
        //     console.log('t1_agg: ' + t1_agg)
        //     console.log('t2_agg: ' + t2_agg)
        // }
    }
    

    
    setTimeout(loop, LOOP_INTERVAL)
}

render_prep()
function center_view() {
    var b = document.body
    b.scrollLeft = (b.scrollWidth - b.clientWidth) / 2
    b.scrollTop = (b.scrollHeight - b.clientHeight) / 2
}
center_view()
loop()

wget = function (url, cb) {
    var r = new XMLHttpRequest()
    r.addEventListener("load", function () {
        cb(this.responseText)
    })
    r.open("GET", url)
    r.send()
}

wget(url_params.chip || 'cpu004.txt', function (x) {
    set_new_model(JSON.parse(x))
})

c.onmousedown = function (e) {
    e.preventDefault()
    var pos = getRelPos(c, e)

    var oldMove = document.onmousemove
    document.onmousemove = function (e) {
        pos = null
    }
    
    var oldUp = document.onmouseup
    document.onmouseup = function (e) {
        document.onmousemove = oldMove
        document.onmouseup = oldUp

        if (pos) my_on_mouse_up(pos, e)
    }
}

c.ontouchstart = function (e) {
    e.preventDefault()
    var pos = getRelPos(c, e.touches[0])

    var oldMove = document.ontouchmove
    document.ontouchmove = function (e) {
        pos = null
    }
    
    var oldEnd = document.ontouchend;
    var oldCancel = document.ontouchcancel
    document.ontouchend = document.ontouchcancel = function (e) {
        document.ontouchmove = oldMove
        document.ontouchend = oldEnd
        document.ontouchcancel = oldCancel;

        if (pos) my_on_mouse_up(pos, e)
    }
}

function my_on_mouse_up(pos, e) {
    var x = Math.floor(pos.x * window.devicePixelRatio / view.scale - (c.width - render_prep_canvas.width)/2) + view.low_x
    var y = Math.floor(pos.y * window.devicePixelRatio / view.scale - (c.height - render_prep_canvas.height)/2) + view.low_y
    var key = x + ',' + y
    
    var changes = {}
    
    var clicked_thing = get_thing_at(x, y)

    if (view.brush == 'toggle_toggle') {
        var best_toggle = null
        var best_distSq = Infinity
        each(model, function (m) {
            if (m.t != 'toggle') { return }
            var distSq = Math.pow(x - m.x, 2) + Math.pow(y - m.y, 2)
            if (distSq < best_distSq) {
                best_distSq = distSq
                best_toggle = m
            }
        })
        if (best_toggle) {
            best_toggle.cc = (best_toggle.cc || -1) * -1
            wave_front[best_toggle.x + ',' + best_toggle.y] = {
                x : best_toggle.x,
                y : best_toggle.y
            }
        }
    } else if (view.brush == 'box') {
        if (e.shiftKey && view.box && view.box.length == 4) {
            if (e.metaKey) {
                var the_dead = delete_view_box(changes)
                each(the_dead, function (_) {
                    var X = _.x - view.box[0] + x
                    var Y = _.y - view.box[1] + y
                    changes[X + ',' + Y] = {
                        x : X,
                        y : Y,
                        t : _.t,
                        c : _.c,
                        v : _.v
                    }
                })
                view.box = [x, y, view.box[2] - view.box[0] + x, view.box[3] - view.box[1] + y]
                view.copy = copy_view_box()
            } else {
                each(view.copy, function (_) {
                    var X = _.x - view.box[0] + x
                    var Y = _.y - view.box[1] + y
                    changes[X + ',' + Y] = {
                        x : X,
                        y : Y,
                        t : _.t,
                        c : _.c,
                        v : _.v
                    }
                })
            }
        } else {
            if (!view.box || view.box.length == 4) {
                view.box = [x, y]
            } else {
                view.box = [
                    Math.min(view.box[0], x),
                    Math.min(view.box[1], y),
                    Math.max(view.box[0], x),
                    Math.max(view.box[1], y)
                ]
                view.copy = copy_view_box()
            }
        }
    } else if (view.brush == 'delete') {
        if (e.shiftKey) {
            function delete_wires_at(x, y) {
                var key = x + ',' + y
                var _ = model[key]
                if (_ && _.t == 'wire') {
                    changes[key] = null
                } else if (_ && _.t == 'cross_gate') {
                    changes[key] = {
                        x : _.x,
                        y : _.y,
                        t : 'wire',
                        c : -1,
                        v : 0
                    }
                }
            }
            var dx = x - view.prev_x
            var dy = y - view.prev_y
            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0)
                    for (var i = view.prev_x; i <= x; i++)
                        delete_wires_at(i, view.prev_y)
                else
                    for (var i = x; i <= view.prev_x; i++)
                        delete_wires_at(i, view.prev_y)
            } else {
                if (dy > 0)
                    for (var i = view.prev_y; i <= y; i++)
                        delete_wires_at(view.prev_x, i)
                else
                    for (var i = y; i <= view.prev_y; i++)
                        delete_wires_at(view.prev_x, i)
            }
        } else if (clicked_thing) {
            changes[clicked_thing.x + ',' + clicked_thing.y] = null
        }
    } else if (clicked_thing && clicked_thing.t == 'toggle') {
        clicked_thing.cc = (clicked_thing.cc || -1) * -1
        wave_front[clicked_thing.x + ',' + clicked_thing.y] = {
            x : clicked_thing.x,
            y : clicked_thing.y
        }
        return
    } else if (view.brush == 'wire') {
        function add_wire(x, y, direction) {
            if (direction == 'horz') {
                if (model[x + ',' + y] &&
                    model[x + ',' + y].t == 'wire' &&
                    model[x + ',' + (y - 1)] &&
                    model[x + ',' + (y - 1)].t == 'wire' &&
                    model[x + ',' + (y + 1)] &&
                    model[x + ',' + (y + 1)].t == 'wire') {
                    changes[x + ',' + y] = {
                        x : x,
                        y : y,
                        t : 'cross_gate',
                        c : -1,
                        v : 0
                    }
                    return
                }
            }
            if (direction == 'vert') {
                if (model[x + ',' + y] &&
                    model[x + ',' + y].t == 'wire' &&
                    model[(x - 1) + ',' + y] &&
                    model[(x - 1) + ',' + y].t == 'wire' &&
                    model[(x + 1) + ',' + y] &&
                    model[(x + 1) + ',' + y].t == 'wire') {
                    changes[x + ',' + y] = {
                        x : x,
                        y : y,
                        t : 'cross_gate',
                        c : -1,
                        v : 0
                    }
                    return
                }
            }
            changes[x + ',' + y] = {
                x : x,
                y : y,
                t : 'wire',
                c : -1,
                v : 0
            }
        }
        if (e.shiftKey) {
            var dx = x - view.prev_x
            var dy = y - view.prev_y
            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0) {
                    for (var i = view.prev_x; i <= x; i++)
                        add_wire(i, view.prev_y, 'horz')
                } else {
                    for (var i = x; i <= view.prev_x; i++)
                        add_wire(i, view.prev_y, 'horz')
                }
            } else {
                if (dy > 0) {
                    for (var i = view.prev_y; i <= y; i++)
                        add_wire(view.prev_x, i, 'vert')
                } else {
                    for (var i = y; i <= view.prev_y; i++)
                        add_wire(view.prev_x, i, 'vert')
                }
            }
        } else {
            add_wire(x, y)
        }
    } else {
        if (clicked_thing) {
            changes[clicked_thing.x + ',' + clicked_thing.y] = null
        }
        changes[key] = {
            x : x,
            y : y,
            t : view.brush,
            c : -1,
            v : 0
        }
    }
    
    view.prev_x = x
    view.prev_y = y
    
    update_model(changes)
}

function getPos(e) {
    var x = 0, y = 0
    while (e != null) {
        x += e.offsetLeft
        y += e.offsetTop
        e = e.offsetParent
    }
    return {x : x, y : y}
}

function getRelPos(to, positionedObject) {
    var pos = getPos(to)
    return {
        x : positionedObject.pageX - pos.x,
        y : positionedObject.pageY - pos.y
    }
}


function each(o, cb) {
	if (o instanceof Array) {
		for (var i = 0; i < o.length; i++) {
			if (cb(o[i], i, o) == false)
				return false
		}
	} else {
		for (var k in o) {
			if (o.hasOwnProperty(k)) {
				if (cb(o[k], k, o) == false)
					return false
			}
		}
	}
	return true
}

</script>
